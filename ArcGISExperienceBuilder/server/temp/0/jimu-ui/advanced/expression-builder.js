System.register(["jimu-core","jimu-ui","jimu-core/react","jimu-layouts/layout-runtime","jimu-core/react-dom/server"],(function(e){var t,n,r,o,s;return{setters:[function(e){t=e},function(e){n=e},function(e){r=e},function(e){o=e},function(e){s=e}],execute:function(){e(function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=949)}({0:function(e,n){e.exports=t},1:function(e,t){e.exports=n},2:function(e,t){e.exports=r},259:function(e,t){e.exports='<svg viewBox="0 0 12 14" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.667V13a.667.667 0 01-1.333 0V1c0-.368.298-.667.666-.667H8c.177 0 .346.07.471.196l2.667 2.666a.667.667 0 01.195.472V13a.667.667 0 01-.666.667H4a.667.667 0 010-1.334h6v-8.39L7.724 1.667H2zm2 6a.667.667 0 110-1.334h4a.667.667 0 010 1.334H4zM4 5a.667.667 0 110-1.333h1.333a.667.667 0 010 1.333H4zm0 5.333A.667.667 0 014 9h2.667a.667.667 0 010 1.333H4z" fill="#FFF" fill-rule="nonzero"></path></svg>'},260:function(e,t){e.exports='<svg viewBox="0 0 12 14" xmlns="http://www.w3.org/2000/svg"><path d="M10.056 3.165V2.063H2.892l4.215 4.534A.732.732 0 017.1 7.602L2.93 11.937h7.125v-.666a.732.732 0 011.463 0v1.397a.733.733 0 01-.732.732H1.213a.73.73 0 01-.528-1.239l4.88-5.074L.677 1.83A.732.732 0 011.213.6h9.574c.404 0 .732.328.732.732v1.833a.733.733 0 01-1.463 0z" fill="#FFF" fill-rule="nonzero"></path></svg>'},261:function(e,t){e.exports='<svg viewBox="0 0 16 12" xmlns="http://www.w3.org/2000/svg"><path d="M2 6l4-4H4L0 6l4 4h2L2 6zm10-4h-2l4 4-4 4h2l4-4-4-4zM8.5 0L6 12h1.5L10 0H8.5z" fill="#FFF" fill-rule="nonzero"></path></svg>'},262:function(e,t){e.exports='<svg viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg"><path d="M3.333 0C2.597 0 2 .597 2 1.333V4c0 .736-.597 1.333-1.333 1.333H0v1.334h.667A1.333 1.333 0 012 8v2.667C2 11.403 2.597 12 3.333 12h1.334v-1.333H3.333V7.333C3.333 6.597 2.736 6 2 6c.736 0 1.333-.597 1.333-1.333V1.333h1.334V0m4 0C9.403 0 10 .597 10 1.333V4a1.333 1.333 0 001.333 1.333H12v1.334h-.667A1.333 1.333 0 0010 8v2.667C10 11.403 9.403 12 8.667 12H7.333v-1.333h1.334V7.333C8.667 6.597 9.264 6 10 6a1.333 1.333 0 01-1.333-1.333V1.333H7.333V0h1.334z" fill="#FFF" fill-rule="nonzero"></path></svg>'},31:function(e,t){e.exports=o},39:function(e,t){e.exports='<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M8 6.598L14.308.29a.991.991 0 011.402 1.402L9.402 8l6.308 6.308a.991.991 0 01-1.402 1.402L8 9.402 1.692 15.71A.991.991 0 01.29 14.308L6.598 8 .29 1.692A.991.991 0 011.692.29L8 6.598z" fill="#000" fill-rule="nonzero"></path></svg>'},43:function(e,t,n){"use strict";var r=n(44);function o(){}function s(){}s.resetWarningCache=o,e.exports=function(){function e(e,t,n,o,s,i){if(i!==r){var a=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw a.name="Invariant Violation",a}}function t(){return e}e.isRequired=e;var n={array:e,bool:e,func:e,number:e,object:e,string:e,symbol:e,any:e,arrayOf:t,element:e,elementType:e,instanceOf:t,node:e,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t,checkPropTypes:s,resetWarningCache:o};return n.PropTypes=n,n}},438:function(e,t){e.exports=s},439:function(e,t,n){"use strict";var r,o=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),s=this&&this.__assign||function(){return(s=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},i=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),p=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.hasOwnProperty.call(e,n)&&i(t,e,n);return a(t,e),t},c=this&&this.__rest||function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n},l=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=p(n(2)),d=l(n(665)),f=p(n(7));function h(e){return e&&e.replace(/&nbsp;|\u202F|\u00A0/g," ")}var x=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lastHtml=t.props.html,t.el="function"==typeof t.props.innerRef?{current:null}:u.createRef(),t.getEl=function(){return(t.props.innerRef&&"function"!=typeof t.props.innerRef?t.props.innerRef:t.el).current},t.emitChange=function(e){var n=t.getEl();if(n){var r=n.innerHTML;if(t.props.onChange&&r!==t.lastHtml){var o=Object.assign({},e,{target:{value:r}});t.props.onChange(o)}t.lastHtml=r}},t}return o(t,e),t.prototype.render=function(){var e=this,t=this.props,n=t.tagName,r=t.html,o=t.innerRef,i=c(t,["tagName","html","innerRef"]);return u.createElement(n||"div",s(s({},i),{ref:"function"==typeof o?function(t){o(t),e.el.current=t}:o||this.el,onInput:this.emitChange,onBlur:this.props.onBlur||this.emitChange,onKeyUp:this.props.onKeyUp||this.emitChange,onKeyDown:this.props.onKeyDown||this.emitChange,contentEditable:!this.props.disabled,dangerouslySetInnerHTML:{__html:r}}),this.props.children)},t.prototype.shouldComponentUpdate=function(e){var t=this.props,n=this.getEl();return!n||(h(e.html)!==h(n.innerHTML)||(t.disabled!==e.disabled||t.tagName!==e.tagName||t.className!==e.className||t.innerRef!==e.innerRef||!d.default(t.style,e.style)))},t.prototype.componentDidUpdate=function(){var e=this.getEl();e&&(this.props.html!==e.innerHTML&&(e.innerHTML=this.props.html),this.lastHtml=this.props.html,function(e){var t=document.createTextNode("");e.appendChild(t);var n=document.activeElement===e;if(null!==t&&null!==t.nodeValue&&n){var r=window.getSelection();if(null!==r){var o=document.createRange();o.setStart(t,t.nodeValue.length),o.collapse(!0),r.removeAllRanges(),r.addRange(o)}e instanceof HTMLElement&&e.focus()}}(e))},t.propTypes={html:f.string.isRequired,onChange:f.func,disabled:f.bool,tagName:f.string,className:f.string,style:f.object,innerRef:f.oneOfType([f.object,f.func])},t}(u.Component);t.default=x},44:function(e,t,n){"use strict";e.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"},665:function(e,t,n){"use strict";var r=Array.isArray,o=Object.keys,s=Object.prototype.hasOwnProperty;e.exports=function e(t,n){if(t===n)return!0;if(t&&n&&"object"==typeof t&&"object"==typeof n){var i,a,p,c=r(t),l=r(n);if(c&&l){if((a=t.length)!=n.length)return!1;for(i=a;0!=i--;)if(!e(t[i],n[i]))return!1;return!0}if(c!=l)return!1;var u=t instanceof Date,d=n instanceof Date;if(u!=d)return!1;if(u&&d)return t.getTime()==n.getTime();var f=t instanceof RegExp,h=n instanceof RegExp;if(f!=h)return!1;if(f&&h)return t.toString()==n.toString();var x=o(t);if((a=x.length)!==o(n).length)return!1;for(i=a;0!=i--;)if(!s.call(n,x[i]))return!1;for(i=a;0!=i--;)if(!e(t[p=x[i]],n[p]))return!1;return!0}return t!=t&&n!=n}},7:function(e,t,n){e.exports=n(43)()},949:function(e,t,n){"use strict";n.r(t),n.d(t,"ExpressionEditor",(function(){return Be})),n.d(t,"ExpressionBuilder",(function(){return tt})),n.d(t,"ExpressionBuilderPopup",(function(){return it})),n.d(t,"ExpressionInput",(function(){return ht})),n.d(t,"ExpressionBuilderType",(function(){return h})),n.d(t,"ExpressionInputType",(function(){return v}));var r={};n.r(r),n.d(r,"ExpressionBuilder",(function(){return a})),n.d(r,"ExpressionEditor",(function(){return l})),n.d(r,"ExpressionInput",(function(){return f}));var o,s=n(0),i=function(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e};function a(e){var t=e.theme;return Object(s.css)(o||(o=i(["\n    .component-expression-builder{\n      .w-33{\n        width: 33% !important;\n      }\n      .secondary-title{\n        font-size: ",";\n        color: ",";\n        font-weight: 400;\n      }\n      .expression-builder-tab{\n        padding-top: 1rem;\n        padding-bottom: 1rem;\n        overflow: hidden;\n        width: 100%;\n        height: calc(100% - 10px);\n      }\n      .has-nav .expression-builder-tab{\n        height: calc(100% - 40px);\n      }\n      .common-tab{\n        .mb-12{\n          margin-bottom: 12px;\n        }\n        .option-label{\n          font-size: ",";\n          font-weight: 500;\n          color: ",";\n        }\n        .data-option{\n          padding-left: 1rem;\n          padding-right: 1rem;\n        }\n      }\n      .field-selector-container{\n        height: 100%;\n      }\n      .expression-editor-container{\n        height: calc(100% - 20px);\n      }\n      .expression-editor-helper{\n        height: calc(100% - 130px);\n      }\n      .exp-editor-helper-tab{\n        height: calc(100% - 30px);\n      }\n      .field-selector-container, .expression-editor-container{\n        width: 100%;\n      }\n      .expression-insert-btn{\n        height: ",";\n      }\n      .expression-insert-btn{\n        max-width: 100%;\n        >button{\n          max-width: 100%;\n        }\n      }\n\n    }\n\n  "],["\n    .component-expression-builder{\n      .w-33{\n        width: 33% !important;\n      }\n      .secondary-title{\n        font-size: ",";\n        color: ",";\n        font-weight: 400;\n      }\n      .expression-builder-tab{\n        padding-top: 1rem;\n        padding-bottom: 1rem;\n        overflow: hidden;\n        width: 100%;\n        height: calc(100% - 10px);\n      }\n      .has-nav .expression-builder-tab{\n        height: calc(100% - 40px);\n      }\n      .common-tab{\n        .mb-12{\n          margin-bottom: 12px;\n        }\n        .option-label{\n          font-size: ",";\n          font-weight: 500;\n          color: ",";\n        }\n        .data-option{\n          padding-left: 1rem;\n          padding-right: 1rem;\n        }\n      }\n      .field-selector-container{\n        height: 100%;\n      }\n      .expression-editor-container{\n        height: calc(100% - 20px);\n      }\n      .expression-editor-helper{\n        height: calc(100% - 130px);\n      }\n      .exp-editor-helper-tab{\n        height: calc(100% - 30px);\n      }\n      .field-selector-container, .expression-editor-container{\n        width: 100%;\n      }\n      .expression-insert-btn{\n        height: ",";\n      }\n      .expression-insert-btn{\n        max-width: 100%;\n        >button{\n          max-width: 100%;\n        }\n      }\n\n    }\n\n  "])),s.polished.rem(14),t.colors.palette.dark[400],s.polished.rem(13),t.colors.palette.dark[400],s.polished.rem(26))}var p,c=function(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e};function l(e){var t=e.theme;return Object(s.css)(p||(p=c(["\n    .component-expression-editor{\n      .mt-18{\n        margin-top: 18px;\n      }\n      .mt-12{\n        margin-top: 12px;\n      }\n      .jimu-nav.nav.nav-pills.nav-fill{\n        border-top: 0;\n        border-left: 0;\n        border-right: 0;\n      }\n      .expression-editor-input{\n        -webkit-user-select: text !important;\n        user-select: text !important;\n        font-size: 13px;\n        font-weight: 400;\n        overflow-x: hidden;\n        overflow-y: auto;\n        min-height: ",";\n        max-height: ",";\n        user-select: none;\n        border: 0;\n        outline: none;\n        background-color: ",";\n        padding: 1px;\n        .expression-editor-input-content-editable:focus{\n          border-color: ",";\n          outline: none;\n        }\n        .expression-editor-input-content-editable{\n          border: 1px solid ",";\n          min-height: ",";\n          max-height: ",";\n          border-radius: 2px;\n          outline: none;\n        }\n        p{\n          min-height: 100%;\n        }\n        .break-all{\n          word-break: break-all;\n        }\n        span.error-exp{\n          color: #FF5066;\n        }\n        .field-exp{\n          color: #FFDE72;\n        }\n        .function-exp{\n          color: #B685FF;\n        }\n        .number-exp{\n          color: #74D3FF;\n        }\n        .string-exp{\n          color: #98FF64;\n        }\n        .operator-exp{\n          color: #F5A623;\n        }\n        .unknown-exp{\n          color: #FF5066;\n        }\n        .ds-disabled-exp{\n          color: #FF5066;\n        }\n      }\n\n      .error-border{\n        border: 1px solid #FF5066;\n        outline: none;\n        .expression-editor-input-content-editable{\n          outline: none;\n          border: 0;\n        }\n      }\n\n      .expression-editor-function-item{\n        border: 1px solid transparent;\n        cursor: pointer;\n        background-color: ",";\n        user-select: none;\n      }\n      .expression-editor-function-item-selected{\n        border: 1px solid ",";\n      }\n      .expression-editor-function-item:hover{\n        background-color: ",";\n      }\n      .expression-editor-function-item:active.expression-editor-function-item:hover{\n        background-color: ",";\n      }\n\n      .exp-editor-helper-tab{\n        margin-left: -16px;\n        margin-right: -16px;\n      }\n\n      .error-message{\n        height: 20px;\n        line-height: 20px;\n      }\n\n      .exp-poper{\n        background-color: ",";\n        border: 1px solid ",";\n        font-size: 13px;\n        width: ",";\n        z-index: 1;\n        padding: 0 !important;\n        box-shadow: 0 0 8px 0 ",";\n        .exp-popper-item{\n          padding-left: 8px;\n          padding-right: 8px;\n        }\n        .jimu-popper--arrow::after {\n          border-bottom-color: "," !important;\n        }\n      }\n      .exp-popper-selected-item, .exp-popper-item:hover{\n        background-color: ",";\n        cursor: pointer;\n      }\n\n    }\n\n  "],["\n    .component-expression-editor{\n      .mt-18{\n        margin-top: 18px;\n      }\n      .mt-12{\n        margin-top: 12px;\n      }\n      .jimu-nav.nav.nav-pills.nav-fill{\n        border-top: 0;\n        border-left: 0;\n        border-right: 0;\n      }\n      .expression-editor-input{\n        -webkit-user-select: text !important;\n        user-select: text !important;\n        font-size: 13px;\n        font-weight: 400;\n        overflow-x: hidden;\n        overflow-y: auto;\n        min-height: ",";\n        max-height: ",";\n        user-select: none;\n        border: 0;\n        outline: none;\n        background-color: ",";\n        padding: 1px;\n        .expression-editor-input-content-editable:focus{\n          border-color: ",";\n          outline: none;\n        }\n        .expression-editor-input-content-editable{\n          border: 1px solid ",";\n          min-height: ",";\n          max-height: ",";\n          border-radius: 2px;\n          outline: none;\n        }\n        p{\n          min-height: 100%;\n        }\n        .break-all{\n          word-break: break-all;\n        }\n        span.error-exp{\n          color: #FF5066;\n        }\n        .field-exp{\n          color: #FFDE72;\n        }\n        .function-exp{\n          color: #B685FF;\n        }\n        .number-exp{\n          color: #74D3FF;\n        }\n        .string-exp{\n          color: #98FF64;\n        }\n        .operator-exp{\n          color: #F5A623;\n        }\n        .unknown-exp{\n          color: #FF5066;\n        }\n        .ds-disabled-exp{\n          color: #FF5066;\n        }\n      }\n\n      .error-border{\n        border: 1px solid #FF5066;\n        outline: none;\n        .expression-editor-input-content-editable{\n          outline: none;\n          border: 0;\n        }\n      }\n\n      .expression-editor-function-item{\n        border: 1px solid transparent;\n        cursor: pointer;\n        background-color: ",";\n        user-select: none;\n      }\n      .expression-editor-function-item-selected{\n        border: 1px solid ",";\n      }\n      .expression-editor-function-item:hover{\n        background-color: ",";\n      }\n      .expression-editor-function-item:active.expression-editor-function-item:hover{\n        background-color: ",";\n      }\n\n      .exp-editor-helper-tab{\n        margin-left: -16px;\n        margin-right: -16px;\n      }\n\n      .error-message{\n        height: 20px;\n        line-height: 20px;\n      }\n\n      .exp-poper{\n        background-color: ",";\n        border: 1px solid ",";\n        font-size: 13px;\n        width: ",";\n        z-index: 1;\n        padding: 0 !important;\n        box-shadow: 0 0 8px 0 ",";\n        .exp-popper-item{\n          padding-left: 8px;\n          padding-right: 8px;\n        }\n        .jimu-popper--arrow::after {\n          border-bottom-color: "," !important;\n        }\n      }\n      .exp-popper-selected-item, .exp-popper-item:hover{\n        background-color: ",";\n        cursor: pointer;\n      }\n\n    }\n\n  "])),s.polished.rem(48),s.polished.rem(100),t.colors.palette.light[200],t.colors.palette.primary[700],t.colors.palette.light[200],s.polished.rem(48),s.polished.rem(100),t.colors.palette.light[400],t.colors.primary,t.colors.palette.light[500],t.colors.white,t.colors.palette.light[200],t.colors.palette.light[800],s.polished.rem(200),s.polished.rgba(t.colors.white,.5),t.colors.palette.light[200],t.colors.secondary)}var u,d=function(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e};function f(e){var t=e.theme;return Object(s.css)(u||(u=d(["\n    .component-expression-input{\n      font-size: ",";\n      .disabled-input-cover{\n        width: 100%;\n        height: 100%;\n        position: relative;\n        top: -100%;\n        &.ds-disabled{\n          background-color: transparent;\n        }\n      }\n      .ds-disabled{\n        background-color: ",";\n        cursor: pointer;\n        border: 0;\n        >span{\n          color: ",";\n          background-color: ",";\n          vertical-align: sub;\n          margin-left: 5px;\n          margin-right: 5px;\n        }\n      }\n      .ds-placeholder{\n        >span{\n          color: ",";\n          background-color: ",";\n        }\n      }\n      .expression-builder-trigger{\n        cursor: pointer;\n        width: 26px;\n        height: 26px;\n        padding: 0;\n        .dropdown-button-content{\n          display: flex;\n          align-items: center;\n          justify-content: center;\n        }\n        .expression-builder-trigger-dropdown{\n          padding: 0;\n          .trigger-dropdown-toggle{\n            background: ",";\n            border-radius: 2px 0 0 2px;\n            border-color: ",";\n          }\n        }\n      }\n      .expression-input{\n        height: ",";\n        .jimu-input, .ds-placeholder{\n          border-radius: 0 2px 2px 0;\n        }\n      }\n    }\n\n  "],["\n    .component-expression-input{\n      font-size: ",";\n      .disabled-input-cover{\n        width: 100%;\n        height: 100%;\n        position: relative;\n        top: -100%;\n        &.ds-disabled{\n          background-color: transparent;\n        }\n      }\n      .ds-disabled{\n        background-color: ",";\n        cursor: pointer;\n        border: 0;\n        >span{\n          color: ",";\n          background-color: ",";\n          vertical-align: sub;\n          margin-left: 5px;\n          margin-right: 5px;\n        }\n      }\n      .ds-placeholder{\n        >span{\n          color: ",";\n          background-color: ",";\n        }\n      }\n      .expression-builder-trigger{\n        cursor: pointer;\n        width: 26px;\n        height: 26px;\n        padding: 0;\n        .dropdown-button-content{\n          display: flex;\n          align-items: center;\n          justify-content: center;\n        }\n        .expression-builder-trigger-dropdown{\n          padding: 0;\n          .trigger-dropdown-toggle{\n            background: ",";\n            border-radius: 2px 0 0 2px;\n            border-color: ",";\n          }\n        }\n      }\n      .expression-input{\n        height: ",";\n        .jimu-input, .ds-placeholder{\n          border-radius: 0 2px 2px 0;\n        }\n      }\n    }\n\n  "])),t.typography.fontSizeBase,t.colors.palette.light[200],t.colors.dark,s.polished.rgba(t.colors.palette.danger[600],.5),t.colors.palette.dark[400],t.colors.transparent,t.colors.palette.light[600],t.colors.palette.light[600],s.polished.rem(26))}var h,x,g=n(1),m=function(){return(m=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};!function(e){e.Attribute="ATTRIBUTE",e.Statistics="STATISTICS",e.Expression="EXPRESSION"}(h||(h={})),function(e){e.Static="STATIC"}(x||(x={}));var v=m(m({},x),h);function y(e,t){var n=s.DataSourceManager.getInstance();if(e&&e.dataSourceId&&t){if(e.dataSourceId.split("-").reverse()[0]===s.CONSTANTS.SELECTION_DATA_VIEW_ID){var r=s.DataSourceManager.getInstance().getDataSource(e.dataSourceId),o=r&&r.getMainDataSource(),i=o&&o.id;return t.some((function(e){return(null==e?void 0:e.mainDataSourceId)===i}))}return!!(t.some((function(t){return(null==t?void 0:t.dataSourceId)===e.dataSourceId}))&&n&&n.getDataSource(e.dataSourceId))}return!0}function b(e,t){if(!e)return"";switch(e){case v.Attribute:return t.formatMessage({id:"attribute",defaultMessage:g.defaultMessages.attribute});case v.Statistics:return t.formatMessage({id:"statistics",defaultMessage:g.defaultMessages.statistics});case v.Expression:return t.formatMessage({id:"expression",defaultMessage:g.defaultMessages.expression});case v.Static:return t.formatMessage({id:"static",defaultMessage:g.defaultMessages.static});default:return""}}var S,E,O=n(438),I=n(439),w=n.n(I);!function(e){e.Part="PART",e.Char="CHAR"}(S||(S={})),function(e){e.Field="FIELD",e.DataSource="DATASOURCE",e.Function="FUNCTION"}(E||(E={}));var C,j=(C=function(e,t){return(C=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}C(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),P=function(e){function t(t){return e.call(this,t)||this}return j(t,e),t.prototype.render=function(){return s.React.createElement("span",{className:this.props.className,contentEditable:!!this.props.isEditable,suppressContentEditableWarning:!0,id:this.props.id,style:this.props.style,title:this.props.title||null,tabIndex:this.props.tabIndex||null},this.props.exp)},t}(s.React.PureComponent),F=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),_=function(){return(_=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},D=function(e){function t(t){var n=e.call(this,t)||this;return n.getDsLabel=function(){var e=s.DataSourceManager.getInstance(),t=e&&e.getDataSource(n.props.dataSourceId);return t?t.getLabel():null},n}return F(t,e),t.prototype.render=function(){var e;return s.React.createElement(P,_({},this.props,{className:Object(s.classNames)("field-exp",(e={},e[this.props.className]=!!this.props.className,e["error-exp"]=this.props.isError,e["ds-disabled-exp"]=this.props.isDsDisabled,e)),style:this.props.style,title:this.getDsLabel(),tabIndex:0}))},t}(s.React.PureComponent),N=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),T=function(){return(T=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},R=function(e){function t(t){var n=e.call(this,t)||this;return n.state={},n}return N(t,e),t.prototype.render=function(){return s.React.createElement(P,T({},this.props,{className:"string-exp",tabIndex:0}))},t}(s.React.PureComponent),k=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),M=function(e){function t(t){var n=e.call(this,t)||this;return n.getFunctionTooltip=function(e){if(!e)return null;switch(n.props.exp){case s.ExpressionFunctions.Average:return"Average ( fieldName ) returns  { Number }";case s.ExpressionFunctions.Count:return"Count ( ) returns  { Number }";case s.ExpressionFunctions.Sum:return"Sum ( fieldName ) returns  { Number }";case s.ExpressionFunctions.Max:return"Max ( fieldName ) returns  { Number }";case s.ExpressionFunctions.Min:return"Min ( fieldName ) returns  { Number }";default:return null}},n}return k(t,e),t.prototype.render=function(){var e;return s.React.createElement("span",{className:Object(s.classNames)("function-exp",(e={},e[this.props.className]=!!this.props.className,e["ds-disabled-exp"]=this.props.isDsDisabled,e)),contentEditable:!!this.props.isEditable,suppressContentEditableWarning:!0,id:this.props.id,title:this.getFunctionTooltip(this.props.exp)},this.props.exp)},t}(s.React.PureComponent),A=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),V=function(){return(V=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},W=function(e){function t(t){return e.call(this,t)||this}return A(t,e),t.prototype.render=function(){var e;return s.React.createElement(P,V({},this.props,{className:Object(s.classNames)("number-exp",(e={},e[this.props.className]=!!this.props.className,e)),style:this.props.style,tabIndex:0}))},t}(s.React.PureComponent),H=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),L=function(){return(L=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},z=function(e){function t(t){var n=e.call(this,t)||this;return n.state={},n}return H(t,e),t.prototype.render=function(){return s.React.createElement(P,L({},this.props,{className:"unknown-exp"}))},t}(s.React.PureComponent),U=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),B=function(){return(B=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},$=function(e){function t(t){return e.call(this,t)||this}return U(t,e),t.prototype.render=function(){return s.React.createElement(P,B({},this.props,{className:"operator-exp"}))},t}(s.React.PureComponent),J=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),q=function(e){function t(t){var n=e.call(this,t)||this;return n.itemHeight=25,n.popoverItemStyle={lineHeight:n.itemHeight+"px !important"},n.getTarget=function(e,t){return e&&t?t.querySelector("#"+e):null},n.state={targetNode:n.getTarget(n.props.targetNodeId,n.props.containerNode)},n}return J(t,e),t.prototype.componentDidUpdate=function(e){if(this.props.selectedItemIndex!==e.selectedItemIndex&&this.props.selectedItemIndex&&this.root){var t=void 0;if(parseInt(this.props.selectedItemIndex)>parseInt(e.selectedItemIndex))if(parseInt(this.props.selectedItemIndex)===this.props.items.length-1)t=this.root.scrollHeight-this.root.offsetHeight;else{var n=Math.floor((this.root.scrollTop+this.root.offsetHeight)/this.itemHeight)-1;t=parseInt(this.props.selectedItemIndex)>=n?this.root.scrollTop+this.itemHeight:this.root.scrollTop}else if(0===parseInt(this.props.selectedItemIndex))t=0;else{var r=Math.floor(this.root.scrollTop/this.itemHeight);t=parseInt(this.props.selectedItemIndex)<=r?this.root.scrollTop-this.itemHeight:this.root.scrollTop}this.root.scrollTo(null,t)}this.props.expSelection===e.expSelection&&this.props.targetNodeId===e.targetNodeId&&this.props.containerNode===e.containerNode||this.setState({targetNode:this.getTarget(this.props.targetNodeId,this.props.containerNode)})},t.prototype.render=function(){var e=this;return this.state.targetNode&&this.props.items&&0!==this.props.items.length?Object(s.jsx)(g.Popper,{reference:this.state.targetNode,open:this.props.isOpen,placement:"bottom",className:"exp-poper",offset:[0,5],showArrow:!0,disablePortal:!0},Object(s.jsx)("div",{style:{width:"200px",maxHeight:"200px",overflow:"auto"},ref:function(t){return e.root=t}},this.props.items.map((function(t,n){return Object(s.jsx)("div",{key:n,onClick:function(){return e.props.onClick&&e.props.onClick(t,e.props.targetNodeId)},className:Object(s.classNames)("text-break exp-popper-item",{"exp-popper-selected-item":""+n===e.props.selectedItemIndex}),title:t.content,css:Object(s.css)(e.popoverItemStyle)},t.content)})))):null},t}(s.React.PureComponent),X=n(31);function K(e,t){return e?t?t.querySelector("#"+e):document&&document.querySelector("#"+e):null}function Y(e,t){if(!t||function(e){if(!e)return!1;var t=e.split("-");return!(!t.length||2!==t.length||"expression"!==t[0]||!/^\d+$/.test(t[1]))}(t.id))return null;for(;t&&!Z(e,t.id);)t=t.parentElement;return t?t.id:null}function G(e,t){return ne(t)?e+"-part-"+t:null}function Q(e,t){if(!t)return null;var n=t.split("-"),r=Z(e,t)?n.length-1:-1;return r>-1?parseInt(n[r]):null}function Z(e,t){if(!t||!e)return!1;var n=function(e,t){return t&&e?t.split(e+"-")[1]:null}(e,t);return!(!n||n.split("-").length!=="part".split("-").length+1||t.indexOf("part")!==e.length+1||!/\d$/.test(t))}function ee(e){return!e||(e.type?e.type===s.ExpressionPartType.String||e.type===s.ExpressionPartType.Field||e.type===s.ExpressionPartType.Operator:(console.warn("Part has no type: ",e),!1))}function te(e){return!!e&&(ae(e)||re(e)||oe(e))}function ne(e){return!isNaN(e)&&"[object Number]"===Object.prototype.toString.call(e)}function re(e){return!(!e||'"'!==e)}function oe(e){return!(!e||"{"!==e)}function se(e){return/^\{(.*?)\}$/.test(e)}function ie(e){return!!e&&/^\"(.*?)\"$/.test(e)}function ae(e){return!!e&&/^[\+\-\*\/\,\(\)\s+]$/.test(e)}function pe(e){return e&&e===s.ExpressionFunctions.Count}function ce(e,t,n,r){var o=function(e,t,n){if(!n||!t||0===t.length)return{};var r={};return t.forEach((function(e){r[e.mainDataSourceId]||(r[e.mainDataSourceId]=[]),r[e.mainDataSourceId].some((function(t){return t.dataSourceId===e.dataSourceId}))||(r[e.mainDataSourceId]=r[e.mainDataSourceId].concat(e))})),r}(0,t,n);Object.keys(o).forEach((function(i){var a;o[i]=null===(a=o[i])||void 0===a?void 0:a.concat(function(e,t,n,r,o){if(!t||0===t.length||!r)return[];var i=[],a=t[0].set("dataSourceId",s.DataSourceManager.getInstance().getDataViewDataSourceId(t[0].mainDataSourceId,s.CONSTANTS.SELECTION_DATA_VIEW_ID)).set("dataViewId",s.CONSTANTS.SELECTION_DATA_VIEW_ID);if(i=i.concat(a),o&&function(e,t,n,r){var o,i,a,p,c=(null===(o=null===window||void 0===window?void 0:window.jimuConfig)||void 0===o?void 0:o.isBuilder)?null===(a=null===(i=Object(s.getAppStore)().getState())||void 0===i?void 0:i.appStateInBuilder)||void 0===a?void 0:a.appConfig:null===(p=Object(s.getAppStore)().getState())||void 0===p?void 0:p.appConfig;if(!(c&&e&&t&&0!==t.length&&n&&r))return!1;for(var l=X.searchUtils.getParentWidgetIdOfContent(c,e,s.LayoutItemType.Widget,r),u=c.widgets[l],d=u&&s.CONSTANTS.PROVIDE_REPEATED_DATA_SOURCE_CONTEXT_WIDGET_URI.some((function(e){return e===u.uri})),f=!1,h=function(e){var r=le(t[e],n);if(f=(null==u?void 0:u.useDataSources)&&u.useDataSources.some((function(e){return(null==r?void 0:r.dataSourceId)===e.dataSourceId})))return"break"},x=0;x<t.length;x++){if("break"===h(x))break}return d&&f}(e,t,n,r)){var p=t[0].set("dataSourceId",s.DataSourceManager.getInstance().getDataViewDataSourceId(t[0].mainDataSourceId,s.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID)).set("dataViewId",s.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID);i=i.concat(p)}return i}(e,o[i],t,n,r))}));var i=Object(s.Immutable)([]);return Object.values(o).forEach((function(e){i=i.concat(e)})),i}function le(e,t){if(!e)return null;if(e.dataViewId===s.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID){var n=t.find((function(t){return t.mainDataSourceId===e.mainDataSourceId}));return n&&Object(s.Immutable)(n)}return e}function ue(e,t){if(e&&e.collapsed&&t){var n,r=e;return!!(r.compareBoundaryPoints&&document&&document.createRange)&&((n=document.createRange()).selectNodeContents(t),n.collapse(!0),r.compareBoundaryPoints(r.START_TO_END,n)<1)}}function de(e,t){if(e&&e.collapsed&&t){var n,r=e;return!!(r.compareBoundaryPoints&&document&&document.createRange)&&((n=document.createRange()).selectNodeContents(t),n.collapse(!1),r.compareBoundaryPoints(r.START_TO_END,n)>-1)}}function fe(e,t,n){var r=K(e,n);if(r&&t>=0&&window.getSelection){var o=function e(t,n,r){if(!document||!document.createRange)return null;r||((r=document.createRange()).selectNodeContents(t),r.setStart(t,0));if(0===n.count)r.setEnd(t,n.count);else if(t&&n.count>0)if(t.nodeType===Node.TEXT_NODE)t.textContent.length<n.count?n.count-=t.textContent.length:(r.setEnd(t,n.count),n.count=0);else for(var o=0;o<t.childNodes.length&&(r=e(t.childNodes[o],n,r),0!==n.count);o++);return r}(r,{count:t});o&&(o.collapse(!1),window.getSelection().removeAllRanges(),window.getSelection().addRange(o))}}function he(){var e=null;if(window.getSelection&&window.getSelection().getRangeAt){var t=window.getSelection();t.rangeCount>0&&(e=t.getRangeAt(0))}return e}function xe(e,t){var n=he();if(!n)return console.warn("Can not get range"),null;var r=null,o=n.startContainer.nodeType===Node.TEXT_NODE?n.startContainer.parentElement:n.startContainer,s=o===(n.endContainer.nodeType===Node.TEXT_NODE?n.endContainer.parentElement:n.endContainer)&&o&&Z(e,o.id),i=s?o:null,a=s?o.id:null;return i&&a&&(r={partId:a,startOffset:n.startOffset,endOffset:n.endOffset,contentLength:i.textContent.length||0}),r}function ge(e){var t,n,r=document&&document.querySelector("#"+e),o=he();if(r&&o)for(t=r.lastElementChild;t;){if(de(o,t)&&Z(e,t.id)){n=t;break}t=t.previousElementSibling}return n}function me(e){var t,n,r=document&&document.querySelector("#"+e),o=he();if(r&&o)for(t=r.firstElementChild;t;){if(ue(o,t)&&Z(e,t.id)){n=t;break}t=t.nextElementSibling}return n}function ve(e,t,n,r,o){var s=K(t,document&&document.querySelector("#"+e)),i=null;return s?(!n&&s.nextElementSibling&&Z(e,s.nextElementSibling.id)?i=s.nextElementSibling.id:n&&s.previousElementSibling&&Z(e,s.previousElementSibling.id)&&(i=s.previousElementSibling.id),i?{type:S.Char,partId:i,startOffset:n?K(i,document&&document.querySelector("#"+e)).textContent.length:0}:{partId:G(e,n?0:o&&o.length>0?o.length-1:0),toStart:n,type:S.Part}):null}function ye(e){var t,n=he();if(n.collapsed){var r=ge(e);t=r&&r.id&&Z(e,r.id)&&Q(e,r.id)}else n.startContainer.nodeType===Node.TEXT_NODE&&(/^\ufeff$/.test(n.startContainer.textContent)||/^\ufeff$/.test(n.startContainer.parentElement.previousSibling.textContent))?t=0:n.startContainer.id===e?t=n.startOffset-1:Z(e,n.startContainer.id)?t=Q(e,n.startContainer.id)+n.startOffset+1:console.warn("Can not get start part of selection");return ne(t)?t:null}function be(e,t){void 0===t&&(t=[]);var n,r=he();if(r.collapsed){var o=ge(e);n=o&&o.id&&Z(e,o.id)&&Q(e,o.id)}else r.endContainer.nodeType===Node.TEXT_NODE&&(/^\ufeff$/.test(r.endContainer.textContent)||/^\ufeff$/.test(r.startContainer.parentElement.previousSibling.textContent))?n=t.length-1>-1?t.length-1:0:r.endContainer.id===e?n=r.endOffset-2:Z(e,r.endContainer.id)?n=Q(e,r.endContainer.id)-r.endOffset-1:console.warn("Can not get end part of selection");return ne(n)?n:null}function Se(e,t,n,r,o,i){var a=null;if(!n)return a;var p=Object.keys(n).find((function(e){return n[e]&&n[e].part&&(n[e].part.type===s.ExpressionPartType.String&&'""'===n[e].part.exp||n[e].part.type===s.ExpressionPartType.Field&&"{}"===n[e].part.exp)}));if(p&&n[p]&&n[p].part)a={partId:G(e,parseInt(p)),type:S.Char,startOffset:1};else{var c=function(e){return e?Object.keys(e).filter((function(t){return e[t]&&e[t].part&&!e[t].isReplacing})).map((function(e){return parseInt(e)})):[]}(n),l=function(e){return e?Object.keys(e).filter((function(t){return e[t]&&!e[t].part&&e[t].isReplacing})).map((function(e){return parseInt(e)})):[]}(n),u=c.length>0;if(l.length>0){var d=Math.min.apply(null,l)-1,f=r[d];if(t)if(f)a=l.length===Object.keys(n).length?{partId:G(e,d),type:S.Char,startOffset:f.type===s.ExpressionPartType.String||f.type===s.ExpressionPartType.Field?f.exp.length-1:f.exp.length}:Ee(e,r,n);else a={partId:G(e,d>-1?d:0),type:S.Part,toStart:!0};else if(l.length===Object.keys(n).length){var h=!(d>-1);a={partId:G(e,d>-1?d:0),type:S.Part,toStart:h}}else a=Ee(e,r,n)}else if(u)if(c.length===Object.keys(n).length){var x=Math.max.apply(null,c),g=G(e,x),m=n[x]&&n[x].part;a={partId:g,type:S.Char,startOffset:m&&m.exp&&m.exp.length}}else a=Ee(e,r,n);else{var v=Oe(e,n),y=ne(v)?v:parseInt(Object.keys(n)[0]),b=ne(y)&&G(e,y);if(t){var E=o&&o.partId,O=b===E,I=o.endOffset-(ne(i)?i:0),w=r[Q(e,E)],C=w&&w.exp?w.exp.length:-1;a={partId:b,type:S.Char,startOffset:O&&I>=0&&I<=C?I:n[y]&&ne(n[y].startOffset)?n[y].startOffset:0}}else a={partId:b,type:S.Char,startOffset:n[y].startOffset}}}return a}function Ee(e,t,n){var r=Oe(e,n),o=ne(r),s=o?r:t.length-1,i=o?n[r].startOffset:0;return{partId:G(e,s),type:S.Char,startOffset:i}}function Oe(e,t){var n=Object.keys(t).find((function(e){return t[e].part&&ne(t[e].startOffset)}));return parseInt(n)}var Ie=function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),o=0;for(t=0;t<n;t++)for(var s=arguments[t],i=0,a=s.length;i<a;i++,o++)r[o]=s[i];return r};function we(e){var t=function(e){var t=e.split(/([\"])/g).filter((function(e){return!!e})),n="",r=!1,o=!1,s=[];return t.forEach((function(e,i){'"'===e?(n+=e,o=r,(r=!0)&&o&&(s.push(n),n="",r=!1,o=!1)):r?n+=e:s.push(e),i===t.length-1&&r&&!o&&s.push(n)})),s}(e.replace(/\ufeff/g,""));return t=function(e){var t=e.map((function(e){return ie(e)||se(e)?e:e.split(/(\s*[\+\-\*\/\(\)\s]\s*)/g).filter((function(e){return!!e}))}));return t=Array.prototype.concat.apply([],t)}(t=function(e){var t=e.map((function(e){return ie(e)?e:e.split(/({[^\{\}]*})/g).filter((function(e){return!!e}))}));return t=Array.prototype.concat.apply([],t)}(t))}function Ce(e,t,n,r,o){var s={};return!e||!ne(t)||t<0||e.forEach((function(e,i){var a=ne(n)&&n>-1&&i===n,p=ne(o)&&o>-1&&i===o?r:null;s[t+i]={part:e,isReplacing:a,startOffset:p}})),s}function je(e,t){if(void 0===t&&(t=[]),!e)return t;var n=(t=t||[]).slice(),r=0,o=[];return Object.keys(e).sort((function(e,t){return parseInt(e)-parseInt(t)})).forEach((function(t){r+=e[t].isReplacing?1:0,e[t].part&&o.push(e[t].part)})),n.splice.apply(n,Ie([Math.min.apply(null,Object.keys(e)),r],o)),n}function Pe(e){return!!e&&(e===s.ExpressionPartType.Field||e===s.ExpressionPartType.Function)}function Fe(e,t){if(!e||!t)return null;var n=s.DataSourceManager.getInstance().getDataSource(e),r=n&&n.getSchema&&n.getSchema(),o=r&&r.fields;return o&&Object.keys(o).sort((function(e,t){return e.localeCompare(t)})).find((function(e){return(o[e].alias||o[e].name)===t}))||null}function _e(e,t,n,r){return se(e)?{type:s.ExpressionPartType.Field,exp:e,dataSourceId:t,jimuFieldName:r||Fe(t,e.replace(/^\{/,"").replace(/\}$/,"")),isFromRepeatedDataSourceContext:!!n}:function(e){return!!e&&Object.keys(s.ExpressionFunctions).some((function(t){return s.ExpressionFunctions[t]===e}))}(e)?{type:s.ExpressionPartType.Function,exp:e,dataSourceId:(o=e,o&&o===s.ExpressionFunctions.Count?t:void 0)}:function(e){return!!e&&(/^\d*\.?\d+(\d|\s)*$/.test(e)||/^\d+\.?\d*(\d|\s)*$/.test(e))}(e)?{type:s.ExpressionPartType.Number,exp:e}:ae(e)?{type:s.ExpressionPartType.Operator,exp:e}:ie(e)?{type:s.ExpressionPartType.String,exp:e}:{type:s.ExpressionPartType.Unknown,exp:e};var o}function De(e,t,n,r){if(void 0===t&&(t=[]),!t||!ne(n)||!ne(r))return null;var o=t[n-1],s=t[r+1],i={};if(o&&s&&!ee(o)&&!ee(s))for(var a=we(o.exp+s.exp).map((function(e,t){return _e(e)})),p=n-1;p<=r+1;p++)i[p]={part:a[p-(n-1)]||null,isReplacing:!0,startOffset:a[p-(n-1)]?o.exp.length:null};else for(p=n;p<=r;p++)i[p]={part:null,isReplacing:!0,startOffset:null};return i}function Ne(e,t,n,r,o){void 0===t&&(t=[]);var s=Q(e,n),i=t&&t[s];if(!i||!i.exp||!ne(r)||!ne(o)||r<0||o<0)return null;var a,p,c,l={},u=i.exp.slice(r,o+1),d=0===r,f=o===i.exp.length-1;if((p=_e(a=(d||f)&&re(u)?i.exp.replace(/^\"/,"").replace(/\"$/,""):d&&oe(u)||f&&((c=u)&&"}"===c)?i.exp.replace(/^\{/,"").replace(/\}$/,""):""+i.exp.slice(0,r)+i.exp.slice(o+1),i.dataSourceId,i.isFromRepeatedDataSourceContext,i.jimuFieldName)).exp.length>0)if(ee(p))l[s]={part:p,isReplacing:!0,startOffset:r+1-(o-r+1)};else{var h=t[s-1],x=t[s+1],g=we(a.replace(/\"/g,'""').replace(/\{/g,"{}")).map((function(e){return _e(e)})),m=ee(h),v=ee(x),y=void 0,b=void 0;h&&x&&!m&&!v?(b=h.exp+a+x.exp,y=2):h&&!m?(b=h.exp+a,y=1):x&&!v?(b=a+x.exp,y=1):(b=a,y=0);var S=void 0,E=void 0;h&&!m?(S=s-1,E=d?h.exp.length:f?g[g.length-1].exp.length:0):(S=s,E=d?0:f?g[g.length-1].exp.length:0);for(var O=we(b.replace(/\"/g,'""').replace(/\{/g,"{}")).map((function(e){return _e(e)})),I=d?S:f?S+O.length-1:null,w=S;w<=S+O.length+y-1;w++)l[w]={part:O[w-S]||null,isReplacing:w-S<=y,startOffset:w===I?E:null}}else l=De(0,t,s,s);return l}function Te(e,t,n,r,o,i){if(void 0===n&&(n=[]),!t||!n)return[];var a=[],p=Q(e,t),c=n[p];if(c){if(c.type===s.ExpressionPartType.Field){if(c.dataSourceId){var l=s.DataSourceManager.getInstance().getDataSource(c.dataSourceId),u=l&&l.getSchema&&l.getSchema().fields;u&&Object.keys(u).filter((function(e){var t=u[e].alias||u[e].name;return t&&0===t.toLowerCase().indexOf(c.exp.replace(/[\{\}]/g,"").toLowerCase())})).filter((function(e){return!n[p-1]||n[p-1].type!==s.ExpressionPartType.Operator||"("!==n[p-1].exp||!n[p-2]||n[p-2].type!==s.ExpressionPartType.Function||u[e].type===s.JimuFieldType.Number})).sort((function(e,t){return u[e].name.localeCompare(u[t].name)})).forEach((function(e){a.push({id:e,content:u[e].alias||u[e].name,type:E.Field})}))}else if(r&&r.length>0){var d=p>1&&"("===n[p-1].exp&&n[p-2].type===s.ExpressionPartType.Function;a=Re(ce(o,r,i,!d),r)}}else c.type===s.ExpressionPartType.Unknown?(f=s.ExpressionFunctions,Object.keys(f).sort((function(e,t){return e.localeCompare(t)}))).filter((function(e){return 0===s.ExpressionFunctions[e].toLowerCase().indexOf(c.exp.toLowerCase())})).forEach((function(e){a.push({id:e,content:s.ExpressionFunctions[e],type:E.Function})})):c.type===s.ExpressionPartType.Function&&c.exp===s.ExpressionFunctions.Count&&r&&(a=Re(ce(o,r,i,!1),r));var f;return a}}function Re(e,t){var n=[];return e&&e.asMutable().forEach((function(e){var r=s.DataSourceManager.getInstance().getDataSource(le(e,t).dataSourceId);if(r){var o=void 0;o=e.dataViewId?e.dataViewId===s.CONSTANTS.SELECTION_DATA_VIEW_ID?r.getMainDataSource().getLabel()+" / "+s.i18n.getIntl().formatMessage({id:"selectionDataView"}):e.dataViewId===s.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID?r.getMainDataSource().getLabel()+" / "+s.i18n.getIntl().formatMessage({id:"populatedDataView"}):r.getMainDataSource().getLabel()+" / "+r.getLabel():r.getLabel(),n.push({id:e.dataSourceId,content:o,type:E.DataSource})}})),n}function ke(e,t,n){if(!document||!document.querySelector("#"+e))return null;for(var r=ge(e);r&&n[Q(e,r.id)]&&n[Q(e,r.id)].type===s.ExpressionPartType.Operator;)r=r.previousElementSibling;return!t&&r?r.id:function(e){var t=he();return t&&t.collapsed&&t.startContainer?Y(e,t.startContainer):null}(e)}var Me,Ae=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ve=function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),o=0;for(t=0;t<n;t++)for(var s=arguments[t],i=0,a=s.length;i<a;i++,o++)r[o]=s[i];return r};!function(e){e.Fields="FIELDS",e.Functions="FUNCTIONS"}(Me||(Me={}));var We=function(e){function t(t){var n,r,o,i=e.call(this,t)||this;i.dsManager=s.DataSourceManager.getInstance(),i.__unmount=!1,i.ExpEditorHelperTabs=((n={})[Me.Fields]=i.props.intl.formatMessage({id:"fields",defaultMessage:g.defaultMessages.fields}),n[Me.Functions]=i.props.intl.formatMessage({id:"functions",defaultMessage:g.defaultMessages.functions}),n),i.getTab=function(e){var t=i.state.FieldSelector;switch(e){case Me.Fields:return t&&s.React.createElement(t,{widgetId:i.props.widgetId,useDataSources:i.props.useDataSources,onChange:i.onFieldSelect,useSelectionDataView:!0,usePopulatedDataView:!0,selectedFields:i.getSelectedFields()});case Me.Functions:return s.React.createElement(He,{onSelect:i.onFunctionSelect,selectedFunction:i.getSelectedFunction()});default:return null}},i.getSelectedFields=function(){var e,t,n,r=i.getEditingPartIndex(),o=null===(n=null===(t=i.props.expression)||void 0===t?void 0:t.parts)||void 0===n?void 0:n[r];if((null==o?void 0:o.type)===s.ExpressionPartType.Field){var a=o.jimuFieldName;if(a){var p=o.dataSourceId;return p?Object(s.Immutable)(((e={})[p]=[a],e)):null}}return null},i.getSelectedFunction=function(){var e,t,n=i.getEditingPartIndex(),r=null===(t=null===(e=i.props.expression)||void 0===e?void 0:e.parts)||void 0===t?void 0:t[n];return(null==r?void 0:r.type)===s.ExpressionPartType.Function?r.exp:null},i.onFunctionSelect=function(e){if(e){var t,n={type:s.ExpressionPartType.Function,exp:e};t=i.getIsReplacing()?[n]:[n,{type:s.ExpressionPartType.Operator,exp:"("},{type:s.ExpressionPartType.Operator,exp:")"}],i.changeExpression(t,i.props.expression)}},i.onFieldSelect=function(e,t,n){var r=e&&e[0];if(r&&t){var o={type:s.ExpressionPartType.Field,exp:"{"+(r.alias||r.name)+"}",dataSourceId:t.id,jimuFieldName:r.jimuName,isFromRepeatedDataSourceContext:n};i.changeExpression([o],i.props.expression)}},i.onActiveTabChange=function(e){i.setState({active:e})},i.getSelectionPartId=function(){var e,t;if(i.props.inEditablePart){var n=xe(i.props.externalId,i.props.container);t=n&&n.partId}else{var r=ge(i.props.externalId);t=r&&r.id}return(t=t||(null===(e=i.props.expSelection)||void 0===e?void 0:e.partId))||(t=G(i.props.externalId,0)),t},i.changeExpression=function(e,t){if(e){var n=i.getIsReplacing(),r=i.getNewPartIndex(e,t,n),o=G(i.props.externalId,r),s=t&&t.parts&&t.parts.slice()||[];if(0===s.length)s=e;else{var a=n?1:0;s.splice.apply(s,Ve([r,a],e))}i.props.onSelect({name:t&&t.name||i.props.externalId,parts:s},o,n)}},i.getNewPartIndex=function(e,t,n){if(!e)return null;var r;if(0===(t&&t.parts||[]).length)r=0;else if(n)r=i.getEditingPartIndex();else{var o=i.getSelectionPartId(),a=Q(i.props.externalId,o);r=function(e){if(!e)return!1;var t=e[0]&&e[0].type===s.ExpressionPartType.Function,n=e[1]&&e[1].type===s.ExpressionPartType.Operator&&"("===e[1].exp,r=e[e.length-1]&&e[e.length-1].type===s.ExpressionPartType.Operator&&")"===e[e.length-1].exp;return t&&n&&r}(e)?a+1:a+e.length}return r},i.getEditingPartIndex=function(){if(!i.props.inEditablePart)return null;var e=i.getSelectionPartId();return Q(i.props.externalId,e)},i.getIsReplacing=function(){var e,t,n=i.getEditingPartIndex(),r=null===(t=null===(e=i.props.expression)||void 0===e?void 0:e.parts)||void 0===t?void 0:t[n];return(null==r?void 0:r.type)===s.ExpressionPartType.Field||(null==r?void 0:r.type)===s.ExpressionPartType.Function};var a=i.getEditingPartIndex(),p=null===(o=null===(r=i.props.expression)||void 0===r?void 0:r.parts)||void 0===o?void 0:o[a];return i.state={active:(null==p?void 0:p.type)===s.ExpressionPartType.Function?Me.Functions:Me.Fields,FieldSelector:null},i}return Ae(t,e),t.prototype.componentDidMount=function(){var e=this;this.__unmount=!1,s.moduleLoader.loadModule("jimu-ui/advanced/data-source-selector").then((function(t){return!e.__unmount&&e.setState({FieldSelector:t.FieldSelector})}))},t.prototype.componentDidUpdate=function(e){var t,n;if(e.expSelection!==this.props.expSelection&&this.getIsReplacing()){var r=this.getEditingPartIndex(),o=null===(n=null===(t=this.props.expression)||void 0===t?void 0:t.parts)||void 0===n?void 0:n[r];this.setState({active:(null==o?void 0:o.type)===s.ExpressionPartType.Function?Me.Functions:Me.Fields})}},t.prototype.componentWillUnmount=function(){this.__unmount=!0},t.prototype.render=function(){var e=this;return this.props.container?s.React.createElement("div",{className:"exp-editor-helper h-100"},s.React.createElement(g.Nav,{fill:!0,pills:!0},Object.keys(Me).map((function(t,n){return s.React.createElement(g.NavItem,{key:n,style:{width:100/Object.keys(Me).length+"%"}},s.React.createElement(g.NavLink,{className:"text-truncate",onClick:function(){e.onActiveTabChange(Me[t])},active:e.state.active===Me[t]},e.ExpEditorHelperTabs[Me[t]]))}))),s.React.createElement("div",{className:"exp-editor-helper-tab"},this.getTab(this.state.active))):null},t}(s.React.PureComponent),He=function(e){var t=e.onSelect,n=e.selectedFunction;return s.React.createElement("div",{className:"mt-18 px-3"},Object.keys(s.ExpressionFunctions).map((function(e,r){return s.React.createElement("div",{onClick:function(){return t(s.ExpressionFunctions[e])},key:r,className:Object(s.classNames)("mt-12 p-1 expression-editor-function-item",{"expression-editor-function-item-selected":n===s.ExpressionFunctions[e]})},s.ExpressionFunctions[e])})))},Le=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ze=function(e){function t(n){var r=e.call(this,n)||this;return r.expressionString="",r.ltrStyle={direction:"ltr"},r.resizeHelperContainer=function(){var e,t,n,o,s=(null===(t=null===(e=r.contentEditableContainer)||void 0===e?void 0:e.current)||void 0===t?void 0:t.offsetHeight)||0,i=(null===(o=null===(n=r.errorMsgContainer)||void 0===n?void 0:n.current)||void 0===o?void 0:o.offsetHeight)||0;r.helperContainer.current.style.height="calc(100% - 30px - "+s+"px - "+i+"px)"},r.setSelectionToEnd=function(){r.setState({isPopoverOpen:!1,expSelection:{partId:r.props.expression&&r.props.expression.parts&&G(r.id,r.props.expression.parts.length-1)||G(r.id,0),type:S.Part,toStart:!1}})},r.getWhetherLoseFocus=function(){var e=window.getSelection&&window.getSelection();return!(e&&r.contentEditableContainer&&r.contentEditableContainer.current.contains(e.focusNode)&&r.contentEditableContainer.current!==e.focusNode)},r.getExpressionString=function(e){var t=e||r.contentEditableContainer?r.contentEditableContainer.current:document,n=t&&t.querySelector("#"+r.id);return n?n.textContent.replace(/\ufeff/g,""):""},r.getComponent=function(e,t){var n=G(r.id,t),o=r.getWhetherInEditablePart();switch(e.type){case s.ExpressionPartType.Field:return Object(s.jsx)(D,{exp:e.exp,id:n,key:t,isDsDisabled:!y(e,r.props.useDataSources),isEditable:o&&r.state.expSelection.partId===n,dataSourceId:e.dataSourceId,isError:!s.expressionUtils.getWhetherFieldInDs(e.dataSourceId,e.jimuFieldName,e.exp.replace(/^\{/,"").replace(/\}$/,""))});case s.ExpressionPartType.String:return Object(s.jsx)(R,{exp:e.exp,id:n,key:t,isEditable:o&&r.state.expSelection.partId===n});case s.ExpressionPartType.Operator:return Object(s.jsx)($,{exp:e.exp,id:n,key:t,isEditable:o&&r.state.expSelection.partId===n});case s.ExpressionPartType.Function:return Object(s.jsx)(M,{exp:e.exp,id:n,key:t,isDsDisabled:!y(e,r.props.useDataSources),isEditable:o&&r.state.expSelection.partId===n,externalId:r.id,dataSourceIds:r.props.useDataSources.map((function(e){return e.dataSourceId}))});case s.ExpressionPartType.Number:return Object(s.jsx)(W,{exp:e.exp,id:n,key:t,isEditable:o&&r.state.expSelection.partId===n});case s.ExpressionPartType.Unknown:return Object(s.jsx)(z,{exp:e.exp,id:n,key:t,isEditable:o&&r.state.expSelection.partId===n});default:return null}},r.getWhetherInEditablePart=function(){return!(!r.state.expSelection||r.state.expSelection.type!==S.Char)},r.getSingleExpFromPopoverItem=function(e){switch(e.type){case E.Field:return"{"+e.content+"}";default:return e.content}},r.renderPartsToHtml=function(e){return O.renderToStaticMarkup(Object(s.jsx)("p",{id:r.id,className:"w-100 m-0 p-1",spellCheck:!1,style:{textAlign:"left"}},"\ufeff",e&&e.map((function(e,t){return r.getComponent(e,t)})),"\ufeff"))},r.getNewExpression=function(e){return{parts:e,name:r.props.expression&&r.props.expression.name||r.id}},r.onChange=function(e){var t=e.currentTarget.querySelector("#"+r.id);if(t&&e.isTrusted){var n=r.getExpressionString(t),o=function(e,t){var n=e.split("");return t.split("").find((function(e,t){return e!==n[t]}))}(r.expressionString,n);if(o){var s=r.getWhetherInEditablePart(),i=r.props.expression&&r.props.expression.parts,a=s?he():null,p=me(r.id),c=function(e,t,n,r,o,s,i){void 0===t&&(t=[]);var a={};if(!n)return a;t=t||[];var p=i?Q(e,i.id):t.length,c=re(n)?'""':oe(n)?"{}":n,l=we(c).map((function(e){return _e(e)})),u=l[0]&&1===l[0].exp.length?te(l[0].exp):ee(l[0]),d=l[l.length-1]&&1===l[l.length-1].exp.length?te(l[l.length-1].exp):ee(l[l.length-1]);if(r){var f=p-1>0?p-1:0,h=t[f],x=ee(h),g=s&&s.startOffset,m=s&&s.startContainer,v=!(!g||g!==n.length),y=!(!g||!m||g!==m.textContent.length);if(x)if(v)if(ee(j=t[C=f-1])||u)a=Ce(l,f);else a=Ce(D=we(j.exp+c).map((function(e){return _e(e)})),C,0,D[D.length-1].exp.length,D.length-1);else if(y){if((_=ee(P=t[p]))||d)a=Ce(l,p);else{var b=(D=we(c+P.exp).map((function(e){return _e(e)})))[D.length-1].exp.length-P.exp.length>-1?D[D.length-1].exp.length-P.exp.length:D[D.length-1].exp.length;a=Ce(D,p,D.length-1,b,D.length-1)}}else{var S=t[f],E=m&&m.textContent,O=S&&E&&_e(E,S.dataSourceId,S.isFromRepeatedDataSourceContext,S.jimuFieldName);a[f]={part:O,isReplacing:!0,startOffset:s&&s.startOffset}}else if(v)if(d)a=Ce(l,f);else{var I=(D=we(c+h.exp).map((function(e){return _e(e)})))[D.length-1].exp.length-h.exp.length>-1?D[D.length-1].exp.length-h.exp.length:D[D.length-1].exp.length;a=Ce(D,f,D.length-1,I,D.length-1)}else if(y){if(u)a=Ce(l,p);else a=Ce(D=we(h.exp+c).map((function(e){return _e(e)})),f,0,D[0].exp.length,0)}else{var w=we((m&&m.textContent).replace(/\"/g,'""').replace(/\{/g,"{}")).map((function(e){return _e(e)}));a=Ce(w,f,0,I=1===w.length?g:w[w.length-1].exp.length,1===w.length?0:w.length-1)}}else{var C,j,P=t[p],F=ee(j=t[C=p-1>0?p-1:0]),_=ee(P);if(F&&_)a=Ce(l,p);else if(_)if(F)console.warn("One mergeable part can not be next to another mergeable part");else{if(u)a=Ce(l,p);else a=Ce(D=we(j.exp+c).map((function(e){return _e(e)})),C,0,D[0].exp.length,0)}else if(d)a=Ce(l,p);else{var D;g=(D=we(c+P.exp).map((function(e){return _e(e)})))[D.length-1].exp.length-P.exp.length>-1?D[D.length-1].exp.length-P.exp.length:D[D.length-1].exp.length;a=Ce(D,p,D.length-1,g,D.length-1)}}return a}(r.id,i,o,s,r.props.useDataSources.asMutable().map((function(e){return e.dataSourceId})),a,p),l=je(c,i),u=s?xe(r.id,document&&document.querySelector("#"+r.id)):null,d=Se(r.id,s,c,l,u);r.setState({isPopoverOpen:!1,expSelection:d},(function(){r.setState({isPopoverOpen:!0})})),r.props.onChange(r.getNewExpression(l))}}},r.onClick=function(e){var t=Y(r.id,e.target),n=Q(r.id,t);if(!ne(n)||n<0)(e.target===r.contentEditableContainer.current||r.contentEditableContainer.current.contains(e.target))&&r.setSelectionToEnd();else{var o=n>-1?K(t,r.contentEditableContainer.current):null;if(o&&r.state.expSelection&&(r.state.expSelection.type!==S.Char||Q(r.id,r.state.expSelection.partId)!==n)&&r.props.expression&&r.props.expression.parts&&r.props.expression.parts[n]){var s={partId:t,type:S.Char,startOffset:o.textContent.length};r.setState({expSelection:s,isPopoverOpen:!1},(function(){return r.setState({isPopoverOpen:Pe(r.props.expression.parts[n].type)})}))}}},r.onHelperItemSelect=function(e,t,n){if(r.props.onChange(e),e&&e.parts&&t){var o=Q(r.id,t),i=e.parts[o];if(!i)return void console.warn("Can not move selection because can not find part: ",t);var a=!1,p={type:S.Char,partId:t,startOffset:i.exp.length};if(i.type===s.ExpressionPartType.Function){var c=pe(i.exp),l=i.dataSourceId;n?c&&!l&&(a=!0):(p={type:S.Part,partId:G(r.id,Q(r.id,t)+1),toStart:!1},c&&(l?p.partId=G(r.id,Q(r.id,t)+2):a=!0))}r.setState({expSelection:p,isPopoverOpen:!1},(function(){return r.setState({isPopoverOpen:a})}))}},r.onBlur=function(e){r.props.onChange(r.props.expression)},r.onKeyDown=function(e){if(e.stopPropagation(),e.nativeEvent.stopImmediatePropagation(),8===e.keyCode||46===e.keyCode||39===e.keyCode||37===e.keyCode||13===e.keyCode||40===e.keyCode||38===e.keyCode)e.preventDefault(),8!==e.keyCode&&46!==e.keyCode||function(e){if(e){var t=new Event("input",{bubbles:!0,cancelable:!0});e.dispatchEvent(t)}}(e.currentTarget),8===e.keyCode?r.handleBackspace():46===e.keyCode?r.handleDelete():37===e.keyCode?r.handleLeftArrow():39===e.keyCode?r.handleRightArrow():13===e.keyCode?r.handleEnter():40===e.keyCode?r.handleDownArrow():38===e.keyCode&&r.handleUpArrow();else if(e.keyCode>=48&&e.keyCode<=57||e.keyCode>=65&&e.keyCode<=90){he().collapsed||r.handleBackspace()}},r.handleBackspace=function(){var e,t,n=r.props.expression&&r.props.expression.parts;if(r.getWhetherInEditablePart()){var o=xe(r.id,r.contentEditableContainer.current);if(o&&o.partId){var s=o.startOffset===o.endOffset?o.startOffset-1:o.startOffset,i=o.endOffset-1;e=Ne(r.id,n,o.partId,s,i),t=i-s+1}}else{var a=ye(r.id),p=be(r.id,n);e=De(r.id,n,a,p),t=0}r.doRemove(e,n,t)},r.handleDelete=function(){var e,t,n=r.props.expression&&r.props.expression.parts;if(r.getWhetherInEditablePart()){var o=xe(r.id,r.contentEditableContainer.current);if(o&&o.partId){var s=o.startOffset,i=o.startOffset===o.endOffset?o.endOffset:o.endOffset-1;e=Ne(r.id,n,o.partId,s,i),t=s===i?0:i-s+1}}else{var a=ye(r.id),p=be(r.id,n),c=he(),l=c.collapsed?ne(a)?a+1:0:a,u=c.collapsed?ne(a)?a+1:0:p;e=De(r.id,n,l,u),t=0}r.doRemove(e,n,t)},r.doRemove=function(e,t,n){var o=je(e,t),s=r.getWhetherInEditablePart(),i=s?xe(r.id,document&&document.querySelector("#"+r.id)):null,a=e?Se(r.id,s,e,o,i,n):r.state.expSelection;r.props.onChange(r.getNewExpression(o)),r.setState({isPopoverOpen:!1,expSelection:a},(function(){return r.setState({isPopoverOpen:a.partId&&o[Q(r.id,a.partId)]&&Pe(o[Q(r.id,a.partId)].type)})}))},r.handleLeftArrow=function(){if(r.getWhetherInEditablePart()){var e=xe(r.id,r.contentEditableContainer.current);if(e&&e.partId){var t=e.startOffset-1>-1?{type:S.Char,partId:e.partId,startOffset:e.startOffset-1}:ve(r.id,e.partId,!0,0,r.props.expression&&r.props.expression.parts);r.setState({expSelection:t,isPopoverOpen:!1})}}else{var n=ge(r.id);n&&r.setState({expSelection:{partId:n.id,toStart:!0,type:S.Part},isPopoverOpen:!1})}},r.handleRightArrow=function(){if(r.getWhetherInEditablePart()){var e=xe(r.id,r.contentEditableContainer.current);if(e&&e.partId){var t=e.startOffset+1<=e.contentLength?{type:S.Char,partId:e.partId,startOffset:e.startOffset+1}:ve(r.id,e.partId,!1,0,r.props.expression&&r.props.expression.parts);r.setState({expSelection:t,isPopoverOpen:!1})}}else{var n=me(r.id);n&&r.setState({expSelection:{partId:n.id,toStart:!1,type:S.Part},isPopoverOpen:!1})}},r.handleDownArrow=function(){if(r.state.isPopoverOpen){var e=ke(r.id,r.getWhetherInEditablePart(),r.props.expression&&r.props.expression.parts),t=Te(r.id,e,r.props.expression&&r.props.expression.parts,r.props.useDataSources,r.props.widgetId,r.props.browserSizeMode),n=r.state.selectedPopoverItemIndex;n=n?parseInt(n)<t.length-1?""+(parseInt(r.state.selectedPopoverItemIndex)+1):""+(t.length-1):"0",r.setState({selectedPopoverItemIndex:n})}},r.handleUpArrow=function(){if(r.state.isPopoverOpen){var e=ke(r.id,r.getWhetherInEditablePart(),r.props.expression&&r.props.expression.parts),t=Te(r.id,e,r.props.expression&&r.props.expression.parts,r.props.useDataSources,r.props.widgetId,r.props.browserSizeMode),n=r.state.selectedPopoverItemIndex;n=n?parseInt(n)>0?""+(parseInt(r.state.selectedPopoverItemIndex)-1):"0":""+(t.length-1),r.setState({selectedPopoverItemIndex:n})}},r.handleEnter=function(){if(r.state.isPopoverOpen&&r.state.selectedPopoverItemIndex){var e=ke(r.id,r.getWhetherInEditablePart(),r.props.expression&&r.props.expression.parts),t=Te(r.id,e,r.props.expression&&r.props.expression.parts,r.props.useDataSources,r.props.widgetId,r.props.browserSizeMode);r.setState({selectedPopoverItemIndex:null}),r.handlePopoverItemClick(t[r.state.selectedPopoverItemIndex],e)}else{var n=r.props.expression&&r.props.expression.parts&&r.props.expression.parts.length||0;r.setState({isPopoverOpen:!1,expSelection:{partId:r.state.expSelection&&r.state.expSelection.type===S.Char?r.state.expSelection.partId:G(r.id,n>0?n-1:0),toStart:!1,type:S.Part}})}},r.handlePopoverItemClick=function(e,t){if(e&&t){var n=r.props.expression&&r.props.expression.parts?r.props.expression.parts.slice():[];e.type===E.Field?r.handleFieldPopoverClick(n,t,e):e.type===E.DataSource?r.handleDsPopoverClick(n,t,e):e.type===E.Function&&r.handleFunctionPopoverClick(n,t,e)}},r.handleFieldPopoverClick=function(e,t,n){void 0===e&&(e=[]);var o=Q(r.id,t),s=e[o].dataSourceId,i=_e(r.getSingleExpFromPopoverItem(n),s,e[o].isFromRepeatedDataSourceContext,n.id);e.splice(o,1,i);var a={partId:G(r.id,o),toStart:!1,type:S.Part};r.setState({isPopoverOpen:!1,expSelection:a}),r.props.onChange(r.getNewExpression(e))},r.handleDsPopoverClick=function(e,t,n){void 0===e&&(e=[]);var o,i=Q(r.id,t),a=e.slice();if(n.id.split("-").reverse()[0]===s.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID){var p=n.id.split("-").reverse().slice(1).reverse().join("-"),c=le(Object(s.Immutable)({dataSourceId:n.id,mainDataSourceId:p,dataViewId:s.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID}),r.props.useDataSources);a[i].isFromRepeatedDataSourceContext=!0,a[i].dataSourceId=c&&c.dataSourceId}else a[i].dataSourceId=n.id;if(a[i].type===s.ExpressionPartType.Function&&pe(a[i].exp)){var l=i+2;o={partId:G(r.id,l),type:S.Part,toStart:!1},(i+2>=a.length||"("!==a[i+1].exp||")"!==a[i+2].exp)&&(a=a.slice(0,i+1).concat([{type:s.ExpressionPartType.Operator,exp:"("},{type:s.ExpressionPartType.Operator,exp:")"}]).concat(a.slice(i+1)))}else o={partId:t,type:S.Char,startOffset:a[i].exp.length};r.props.onChange(r.getNewExpression(a)),r.setState({isPopoverOpen:!1,expSelection:o},(function(){return r.setState({isPopoverOpen:!(a[i].type===s.ExpressionPartType.Function&&a[i].exp===s.ExpressionFunctions.Count)})}))},r.handleFunctionPopoverClick=function(e,t,n){void 0===e&&(e=[]);var o=Q(r.id,t),i=_e(r.getSingleExpFromPopoverItem(n)),a={partId:G(r.id,o+1),type:S.Part,toStart:!1};e.splice(o,1,i,{type:s.ExpressionPartType.Operator,exp:"("},{type:s.ExpressionPartType.Operator,exp:")"}),r.props.onChange(r.getNewExpression(e)),r.setState({isPopoverOpen:pe(i.exp),expSelection:a})},t.count++,r.id="expression-"+t.count,r.contentEditableContainer=s.React.createRef(),r.helperContainer=s.React.createRef(),r.state={isPopoverOpen:!1,isEditorMounted:!1,expSelection:null,selectedPopoverItemIndex:null},r}return Le(t,e),t.prototype.componentDidMount=function(){this.resizeObserver=new s.ResizeObserver(this.resizeHelperContainer),this.resizeObserver.observe(this.contentEditableContainer.current),this.expressionString=this.getExpressionString()||"",this.props.autoFocus&&(this.props.expression&&this.props.expression.parts&&1===this.props.expression.parts.length&&this.props.expression.parts[0].type===s.ExpressionPartType.String?this.setState({expSelection:{partId:G(this.id,0),type:S.Char,startOffset:this.props.expression.parts[0].exp.length-1}}):(this.contentEditableContainer.current.focus(),this.setSelectionToEnd())),this.setState({isEditorMounted:!0}),this.contentEditableContainer.current.ondragstart=function(){return!1},this.contentEditableContainer.current.onpaste=function(){return!1}},t.prototype.componentDidUpdate=function(e,t){this.state.expSelection&&this.state.expSelection.partId&&(t.expSelection!==this.state.expSelection||this.props.autoFocus&&this.getWhetherLoseFocus())&&(this.state.expSelection.type===S.Part?function(e,t,n){var r=K(e,n);if(r){if(window.getSelection&&document&&document.createRange){var o=document.createRange();r&&(o.selectNode(r),o.collapse(t),window.getSelection().removeAllRanges(),window.getSelection().addRange(o))}}else n&&n.focus()}(this.state.expSelection.partId,this.state.expSelection.toStart,this.contentEditableContainer.current):this.state.expSelection.type===S.Char&&fe(this.state.expSelection.partId,this.state.expSelection.startOffset,this.contentEditableContainer.current)),e.expression!==this.props.expression&&(this.props.expression&&this.props.expression.parts?this.expressionString=this.getExpressionString():this.expressionString="")},t.prototype.componentWillUnmount=function(){this.resizeObserver.disconnect()},t.prototype.render=function(){var e,t,n;this.state.isPopoverOpen&&(n=ke(this.id,this.getWhetherInEditablePart(),this.props.expression&&this.props.expression.parts));var r=this.renderPartsToHtml(this.props.expression&&this.props.expression.parts);r=r&&r.replace(/&quot;/g,'"');var o=s.expressionUtils.getWhetherExpressionValid(this.props.expression);return Object(s.jsx)(s.MultipleDataSourceComponent,{useDataSources:this.props.useDataSources},Object(s.jsx)("div",{style:this.props.style,onClick:this.onClick,className:Object(s.classNames)("w-100 h-100",(e={},e[this.props.className]=!!this.props.className,e))},Object(s.jsx)("div",{className:"w-100 h-100 component-expression-editor"},Object(s.jsx)("div",{className:Object(s.classNames)("w-100 expression-editor-input",{"error-border":!o})},Object(s.jsx)(w.a,{innerRef:this.contentEditableContainer,html:r,disabled:!(!this.state.expSelection||this.state.expSelection.type!==S.Char),onChange:this.onChange,onKeyDown:this.onKeyDown,onBlur:this.onBlur,className:"w-100 break-all expression-editor-input-content-editable",style:this.ltrStyle}),Object(s.jsx)(q,{targetNodeId:n,containerNode:null===(t=this.contentEditableContainer)||void 0===t?void 0:t.current,expSelection:this.state.expSelection,items:Te(this.id,n,this.props.expression&&this.props.expression.parts,this.props.useDataSources,this.props.widgetId,this.props.browserSizeMode),isOpen:this.state.isPopoverOpen,onClick:this.handlePopoverItemClick,theme:this.props.theme,selectedItemIndex:this.state.selectedPopoverItemIndex})),!o&&Object(s.jsx)("div",{className:"mt-3 error-message",ref:this.errorMsgContainer},this.props.intl.formatMessage({id:"invalidExpression",defaultMessage:g.defaultMessages.invalidExpression})),Object(s.jsx)("div",{className:"expression-editor-helper mt-3",ref:this.helperContainer},Object(s.jsx)(We,{expression:this.props.expression,useDataSources:this.props.useDataSources,onSelect:this.onHelperItemSelect,intl:this.props.intl,externalId:this.id,inEditablePart:this.getWhetherInEditablePart(),container:this.state.isEditorMounted?this.contentEditableContainer.current:null,expSelection:this.state.expSelection,widgetId:this.props.widgetId})))))},t.count=-1,t}(s.React.PureComponent),Ue=s.ReactRedux.connect((function(e,t){var n,r;return{browserSizeMode:(null===(n=null==e?void 0:e.appContext)||void 0===n?void 0:n.isBuilder)?null===(r=null==e?void 0:e.appStateInBuilder)||void 0===r?void 0:r.browserSizeMode:null==e?void 0:e.browserSizeMode}}))(ze),Be=Object(s.injectIntl)(s.themeUtils.withTheme(s.themeUtils.withStyles(Ue,"ExpressionEditor"))),$e=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Je=function(e){function t(t){var n=e.call(this,t)||this;return n.__unmount=!1,n.getSelectedFields=function(){var e;if(!n.props.expression||!n.props.useDataSources)return null;var t=n.props.expression.parts&&n.props.expression.parts[0],r=t&&y(t,n.props.useDataSources)&&t.type===s.ExpressionPartType.Field?t.jimuFieldName:null;if(r){var o=t.dataSourceId;return{fields:o?Object(s.Immutable)(((e={})[o]=[r],e)):null,isSelectedFromRepeatedDataSourceContext:t.isFromRepeatedDataSourceContext}}return null},n.onSelectedFieldsChange=function(e,t,r){var o=e&&e[0];if(o&&t){var i={type:s.ExpressionPartType.Field,exp:"{"+(o.alias||o.name)+"}",dataSourceId:t.id,jimuFieldName:o.jimuName,isFromRepeatedDataSourceContext:!!r};n.props.onChange({name:i.exp,parts:[i]})}},n.state={FieldSelector:null},n}return $e(t,e),t.prototype.componentDidMount=function(){var e=this;this.__unmount=!1,s.moduleLoader.loadModule("jimu-ui/advanced/data-source-selector").then((function(t){return!e.__unmount&&e.setState({FieldSelector:t.FieldSelector})}))},t.prototype.componentWillUnmount=function(){this.__unmount=!0},t.prototype.render=function(){var e=this.state.FieldSelector,t=this.getSelectedFields();return s.React.createElement("div",{className:"expression-builder-tab attribute-tab common-tab p-0"},s.React.createElement("div",{className:"field-selector-container"},e&&s.React.createElement(e,{types:this.props.types,useDataSources:this.props.useDataSources,widgetId:this.props.widgetId,onChange:this.onSelectedFieldsChange,selectedFields:null==t?void 0:t.fields,isSelectedFromRepeatedDataSourceContext:null==t?void 0:t.isSelectedFromRepeatedDataSourceContext,useSelectionDataView:!0,usePopulatedDataView:!0})))},t}(s.React.PureComponent),qe=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Xe=function(){return(Xe=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},Ke=function(e){function t(n){var r=e.call(this,n)||this;return r.getMutableExpression=function(e){return r.props.expression&&r.props.expression.asMutable?r.props.expression.asMutable({deep:!0}):r.props.expression},r.onExpChange=function(e){r.setState({expression:e})},r.onChange=function(){r.props.onChange({name:r.state.name||r.getDefaultName(),parts:r.state.expression&&r.state.expression.parts})},r.onNameChange=function(e){r.setState({name:e.target.value})},r.getDefaultName=function(){return r.props.intl.formatMessage({id:"expression",defaultMessage:g.defaultMessages.expression})+" "+t.count},r.getWhetherDisableInsert=function(){return!r.state.expression||!r.state.expression.parts||0===r.state.expression.parts.length||!s.expressionUtils.getWhetherExpressionValid(r.state.expression)},t.count++,r.state={expression:r.getMutableExpression(r.props.expression),name:r.props.expression&&r.props.expression.name||r.getDefaultName()},r}return qe(t,e),t.prototype.componentDidUpdate=function(e){e.expression!==this.props.expression&&this.setState({expression:this.getMutableExpression(this.props.expression)})},t.prototype.render=function(){return s.React.createElement("div",{className:"expression-builder-tab expression-tab px-3"},s.React.createElement("div",{className:"mb-3"},s.React.createElement("div",{className:"d-flex justify-content-between"},s.React.createElement(g.TextInput,{className:"flex-grow-1",value:this.state.name,onChange:this.onNameChange,id:"expression-name-input",size:"sm"}),s.React.createElement(g.Button,{onClick:this.onChange,type:"primary",disabled:this.getWhetherDisableInsert(),className:"expression-insert-btn ml-2",size:"sm"},s.React.createElement("div",{className:"text-truncate"},this.props.intl.formatMessage({id:"insert",defaultMessage:g.defaultMessages.insert}))))),s.React.createElement("div",{className:"expression-editor-container"},s.React.createElement(Be,Xe({},this.props,{expression:this.state.expression,onChange:this.onExpChange,autoFocus:!0}))))},t.count=0,t}(s.React.PureComponent),Ye=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ge=function(e){function t(t){var n=e.call(this,t)||this;n.dsManager=s.DataSourceManager.getInstance(),n.__unmount=!1,n.getWhetherExpressionIsFuncAndHasOnePart=function(e){return!!e&&!(1!==e.length||!e[0]||e[0].type!==s.ExpressionPartType.Function)},n.hasNoParamAndDsEnabled=function(e){return!!e&&((!e.parts||0===e.parts.length)&&y(e,n.props.useDataSources))},n.hasOneParamAndDsEnabled=function(e){return!!e&&(e.parts&&1===e.parts.length&&y(e.parts[0],n.props.useDataSources))},n.getWhetherUseSelectedDs=function(e){return!n.state||!n.state.selectedDsId||e.dataSourceId===n.state.selectedDsId},n.getDefaultDsId=function(){var e=n.props.expression&&n.props.expression.parts,t=Object(s.groupExpressionPartsByFunction)(e);if(n.getWhetherExpressionIsFuncAndHasOnePart(t)){var r=t[0];if(n.hasNoParamAndDsEnabled(r))return r.dataSourceId;if(n.hasOneParamAndDsEnabled(r))return r.parts[0].dataSourceId}return null},n.getDefaultFunc=function(){var e=n.props.expression&&n.props.expression.parts,t=Object(s.groupExpressionPartsByFunction)(e);return n.getWhetherExpressionIsFuncAndHasOnePart(t)&&t[0].exp||s.ExpressionFunctions.Average},n.getDefaultJimuName=function(e){var t=n.props.expression&&n.props.expression.parts,r=Object(s.groupExpressionPartsByFunction)(t),o=r[0];return n.getWhetherExpressionIsFuncAndHasOnePart(r)&&n.hasOneParamAndDsEnabled(o)&&n.getWhetherUseSelectedDs(o.parts[0])&&o.parts[0].jimuFieldName||e&&Object.keys(e)[0]},n.getDataSourceId=function(){return n.state.selectedDsId},n.getSelectedFieldName=function(e,t){return e?t&&e[t]&&(e[t].alias||e[t].name):""},n.getSelectedJimuFieldName=function(){return n.state.selectedJimuFieldName},n.getSelectedFunction=function(){return n.state.selectedFunction},n.getNumberFields=function(e){if(!e)return{};var t=n.dsManager&&n.dsManager.getDataSource(e),r=t&&t.getSchema(),o=r&&r.fields;if(!o)return{};var i={};return Object.keys(o).forEach((function(e){o[e].type===s.JimuFieldType.Number&&(i[e]=o[e])})),i},n.getDsLabel=function(e){var t=n.dsManager&&n.dsManager.getDataSource(e);return t?t.getLabel()||t.id:e},n.getSelectedUseDataSource=function(){var e,t=s.DataSourceManager.getInstance().getDataSource(n.state.selectedDsId);return n.state.selectedDsId&&t?Object(s.Immutable)({dataSourceId:t.id,mainDataSourceId:t.getMainDataSource().id,dataViewId:t.dataViewId,rootDataSourceId:null===(e=t.getRootDataSource())||void 0===e?void 0:e.id}):null},n.onFieldChange=function(e){var t=e.currentTarget.value;n.setState({selectedJimuFieldName:t})},n.onFunctionChange=function(e){var t=e.currentTarget.value;n.setState({selectedFunction:t})},n.onChange=function(){var e=n.getNumberFields(n.state.selectedDsId),t=n.getSelectedFieldName(e,n.state.selectedJimuFieldName),r=n.state.selectedFunction===s.ExpressionFunctions.Count?n.state.selectedFunction+"()":n.state.selectedFunction+"({"+t+"})",o=[{type:s.ExpressionPartType.Function,exp:n.state.selectedFunction}];n.state.selectedFunction===s.ExpressionFunctions.Count?(o[0].dataSourceId=n.state.selectedDsId,o=o.concat([{type:s.ExpressionPartType.Operator,exp:"("},{type:s.ExpressionPartType.Operator,exp:")"}])):o=o.concat([{type:s.ExpressionPartType.Operator,exp:"("},{type:s.ExpressionPartType.Field,exp:"{"+t+"}",dataSourceId:n.state.selectedDsId,jimuFieldName:n.state.selectedJimuFieldName},{type:s.ExpressionPartType.Operator,exp:")"}]),n.props.onChange({name:r,parts:o})},n.onSelectedUseDsChange=function(e){return n.setState({selectedDsId:null==e?void 0:e.dataSourceId})};var r=n.getDefaultDsId(),o=n.getNumberFields(r),i=n.getDefaultJimuName(o),a=n.getDefaultFunc();return n.state={selectedDsId:r,selectedJimuFieldName:i,selectedFunction:a,MainDataAndViewSelector:null,DataViewPriority:null},n}return Ye(t,e),t.prototype.componentDidMount=function(){var e=this;this.__unmount=!1,s.moduleLoader.loadModule("jimu-ui/advanced/data-source-selector").then((function(t){return!e.__unmount&&e.setState({MainDataAndViewSelector:t.MainDataAndViewSelector,DataViewPriority:t.DataViewPriority})}))},t.prototype.componentDidUpdate=function(e,t){if(e.expression!==this.props.expression||e.useDataSources!==this.props.useDataSources){var n=this.getDefaultDsId(),r=this.getNumberFields(n),o=this.getDefaultJimuName(r),s=this.getDefaultFunc();this.setState({selectedDsId:n,selectedJimuFieldName:o,selectedFunction:s})}if(t.selectedDsId!==this.state.selectedDsId){r=this.getNumberFields(this.state.selectedDsId),o=this.getDefaultJimuName(r);this.setState({selectedJimuFieldName:o})}},t.prototype.componentWillUnmount=function(){this.__unmount=!0},t.prototype.render=function(){var e=this.getNumberFields(this.state.selectedDsId),t=this.state.MainDataAndViewSelector,n=this.state.DataViewPriority;return s.React.createElement("div",{className:"expression-builder-tab statistics-tab common-tab"},t&&s.React.createElement(t,{useDataSources:this.props.useDataSources,onChange:this.onSelectedUseDsChange,useSelectionDataView:!0,className:"p-3",selectedUseDataSource:this.getSelectedUseDataSource(),defaultDataViewPriority:n.Second}),s.React.createElement("div",{className:"data-option mb-12"},s.React.createElement("div",{className:"w-100 text-truncate mb-12 option-label"},this.props.intl.formatMessage({id:"operator",defaultMessage:g.defaultMessages.operator})),s.React.createElement("div",{className:"flex-grow-1"},s.React.createElement(g.Select,{value:this.getSelectedFunction(),className:"select-max-width text-truncate",size:"sm",onChange:this.onFunctionChange},Object.keys(s.ExpressionFunctions).map((function(e,t){return s.React.createElement("option",{value:s.ExpressionFunctions[e],key:t,className:"select-max-width text-truncate"},s.ExpressionFunctions[e])}))))),this.state.selectedFunction&&this.state.selectedFunction!==s.ExpressionFunctions.Count&&s.React.createElement("div",{className:"data-option mb-12"},s.React.createElement("div",{className:"w-100 text-truncate mb-12 option-label"},this.props.intl.formatMessage({id:"field",defaultMessage:g.defaultMessages.field})),s.React.createElement("div",{className:"flex-grow-1"},s.React.createElement(g.Select,{value:this.getSelectedJimuFieldName(),size:"sm",onChange:this.onFieldChange,className:"select-max-width text-truncate"},e&&Object.keys(e).map((function(t,n){return s.React.createElement("option",{value:e[t].jimuName,key:n,className:"select-max-width text-truncate"},e[t].alias||e[t].name)}))))),s.React.createElement("div",{className:"data-option mt-2 float-right expression-insert-btn"},s.React.createElement(g.Button,{onClick:this.onChange,type:"primary"},s.React.createElement("div",{className:"text-truncate"},this.props.intl.formatMessage({id:"insert",defaultMessage:g.defaultMessages.insert})))))},t}(s.React.PureComponent),Qe=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ze=function(){return(Ze=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},et=function(e){function t(t){var n,r=e.call(this,t)||this;return r.expressionFrom=((n={})[h.Attribute]=r.props.intl.formatMessage({id:"attribute",defaultMessage:g.defaultMessages.attribute}),n[h.Statistics]=r.props.intl.formatMessage({id:"statistics",defaultMessage:g.defaultMessages.statistics}),n[h.Expression]=r.props.intl.formatMessage({id:"expression",defaultMessage:g.defaultMessages.expression}),n),r.onChange=function(e){r.props.onChange&&r.props.onChange(e)},r.getActiveExpressionFrom=function(){if(!r.props.expression||!r.props.expression.parts||0===r.props.expression.parts.length)return r.props.types[0];var e=Object(s.groupExpressionPartsByFunction)(r.props.expression.parts);return 1===e.length&&e[0].type===s.ExpressionPartType.Field?r.props.types.some((function(e){return e===h.Attribute}))?h.Attribute:r.props.types.some((function(e){return e===h.Expression}))?h.Expression:r.props.types[0]:1===e.length&&e[0].type===s.ExpressionPartType.Function&&r.props.types.some((function(e){return e===h.Statistics}))?h.Statistics:r.props.types.some((function(e){return e===h.Expression}))?h.Expression:r.props.types[0]},r.getTab=function(e,t,n){switch(e){case h.Attribute:return Object(s.jsx)(Je,{types:r.props.fieldTypes,useDataSources:t,expression:n,onChange:r.onChange,intl:r.props.intl,widgetId:r.props.widgetId});case h.Statistics:return Object(s.jsx)(Ge,{useDataSources:t,expression:n,onChange:r.onChange,intl:r.props.intl,widgetId:r.props.widgetId});case h.Expression:return Object(s.jsx)(Ke,Ze({},r.props,{useDataSources:t,expression:n,onChange:r.onChange,intl:r.props.intl}));default:return null}},r.onActiveTabChange=function(e){r.setState({active:e})},r.state={active:r.getActiveExpressionFrom()},r}return Qe(t,e),t.prototype.componentDidUpdate=function(e,t){this.props.types===e.types&&this.props.expression===e.expression||this.setState({active:this.getActiveExpressionFrom()})},t.prototype.render=function(){var e,t=this;return Object(s.jsx)(s.MultipleDataSourceComponent,{useDataSources:this.props.useDataSources},Object(s.jsx)("div",{style:this.props.style,className:Object(s.classNames)("w-100 h-100",(e={},e[this.props.className]=!!this.props.className,e))},Object(s.jsx)("div",{className:"w-100 h-100 component-expression-builder"},this.props.types&&this.props.types.length>1?Object(s.jsx)(g.Nav,{fill:!0,underline:!0},this.props.types.map((function(e,n){return Object(s.jsx)(g.NavItem,{key:n,className:"w-33"},Object(s.jsx)(g.NavLink,{className:"text-truncate",title:t.expressionFrom[e],onClick:function(){t.onActiveTabChange(e)},active:t.state.active===e},t.expressionFrom[e]))}))):null,Object(s.jsx)("div",{className:Object(s.classNames)("h-100",{"has-nav":this.props.types&&this.props.types.length>1})},this.getTab(this.state.active,this.props.useDataSources,this.props.expression)))))},t}(s.React.PureComponent),tt=Object(s.injectIntl)(s.themeUtils.withStyles(et,"ExpressionBuilder")),nt=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),rt=function(){return(rt=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},ot=n(39),st=function(e){function t(t){var n,r,o,s,i=e.call(this,t)||this;return i.cursorStyle={cursor:"pointer"},i.fontSizeStyle={fontSize:"16px",fontWeight:500,color:null===(s=null===(o=null===(r=null===(n=null==i?void 0:i.props)||void 0===n?void 0:n.theme)||void 0===r?void 0:r.colors)||void 0===o?void 0:o.palette)||void 0===s?void 0:s.dark[600]},i.titleStyle={height:"51px",borderBottom:"0"},i.overflowYStyle={overflow:"hidden",height:"calc(100% - 51px)"},i.__unmount=!1,i.state={SidePopper:null},i}return nt(t,e),t.prototype.componentDidMount=function(){var e=this;this.__unmount=!1,s.moduleLoader.loadModule("jimu-ui/advanced/setting-components").then((function(t){return!e.__unmount&&e.setState({SidePopper:t.SidePopper})}))},t.prototype.componentWillUnmount=function(){this.__unmount=!0},t.prototype.render=function(){var e=this,t=this.state.SidePopper,n=this.props.types,r=n?n.length>1?this.props.intl.formatMessage({id:"dynamicContent",defaultMessage:g.defaultMessages.dynamicContent}):b(n[0],this.props.intl):"";return Object(s.jsx)("div",{className:"w-100 h-100"},t&&Object(s.jsx)(t,{isOpen:this.props.isOpen&&!s.urlUtils.getAppIdPageIdFromUrl().pageId,position:"right"},Object(s.jsx)("div",{className:"h-100 bg-light-300 border-color-gray-400 component-expression-builder-popup"},Object(s.jsx)("div",{className:"w-100 h-100 expression-popup"},Object(s.jsx)("div",{className:"jimu-widget-setting--header d-flex",style:this.titleStyle},Object(s.jsx)("div",{className:"m-0 text-truncate flex-grow-1 d-flex align-items-center",style:this.fontSizeStyle,title:r},r),Object(s.jsx)(g.Button,{size:"sm",icon:!0,type:"tertiary",className:"flex-shrink-0 text-center px-2 pt-1",style:this.cursorStyle,onClick:function(){return e.props.onClose()}},Object(s.jsx)(g.Icon,{icon:ot,size:"16"}))),Object(s.jsx)("div",{style:this.overflowYStyle},Object(s.jsx)(tt,rt({},this.props)))))))},t}(s.React.PureComponent),it=Object(s.injectIntl)(s.themeUtils.withTheme(st)),at=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),pt=function(){return(pt=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},ct=n(259),lt=n(260),ut=n(261),dt=n(262),ft=function(e){function t(t){var n=e.call(this,t)||this;return n.toggleDropdown=function(){return n.setState({isDropdownOpen:!n.state.isDropdownOpen})},n.getExpFromIcon=function(e){switch(e){case v.Static:return ct;case v.Attribute:return dt;case v.Statistics:return lt;case v.Expression:return ut;default:return null}},n.getSelectedExpFromExpression=function(){if(!n.props.expression||!n.props.expression.parts||0===n.props.expression.parts.length)return n.props.types.some((function(e){return e===v.Static}))?v.Static:n.props.types.some((function(e){return e===v.Attribute}))?v.Attribute:n.props.types.some((function(e){return e===v.Statistics}))?v.Statistics:n.props.types.some((function(e){return e===v.Expression}))?v.Expression:null;var e=Object(s.groupExpressionPartsByFunction)(n.props.expression.parts);return 1===e.length&&e[0].type===s.ExpressionPartType.Field?n.props.types.some((function(e){return e===v.Attribute}))?v.Attribute:n.props.types.some((function(e){return e===v.Expression}))?v.Expression:null:1===e.length&&e[0].type===s.ExpressionPartType.Function?n.props.types.some((function(e){return e===v.Statistics}))?v.Statistics:n.props.types.some((function(e){return e===v.Expression}))?v.Expression:null:1===e.length&&e[0].type===s.ExpressionPartType.String&&n.props.types.some((function(e){return e===v.Static}))?v.Static:n.props.types.some((function(e){return e===v.Expression}))?v.Expression:null},n.getWhetherFromExpBuilder=function(e){return e&&Object.keys(h).some((function(t){return h[t]===e}))},n.getExpressionFrom=function(){return n.getWhetherFromExpBuilder(n.state.selectedExpFrom)?Object(s.Immutable)([n.state.selectedExpFrom]):Object(s.Immutable)([])},n.getStringFromExpression=function(){return n.props.expression&&1===n.props.expression.parts.length&&n.props.expression.parts[0].type===s.ExpressionPartType.String?n.props.expression.parts[0].exp.replace(/^"/,"").replace(/"$/,""):""},n.onInputBlur=function(e){var t=e.target.value,r={name:t,parts:[{type:s.ExpressionPartType.String,exp:'"'+t+'"'}]};n.props.onChange&&n.props.onChange(r)},n.onInputChange=function(e){n.setState({inputValue:e.target.value})},n.onExpChange=function(e){n.props.onChange&&n.props.onChange(e)},n.onExpFromChange=function(e){e!==n.state.selectedExpFrom?(n.onExpChange({name:"",parts:[]}),n.setState({selectedExpFrom:e})):n.toggleExpPopup()},n.getWhetherExpDssMatchInUseDss=function(e){var t=e&&e.parts;return!!t&&t.every((function(e){return y(e,n.props.useDataSources)}))},n.toggleExpPopup=function(){n.getWhetherFromExpBuilder(n.state.selectedExpFrom)?n.props.isExpPopupOpen?n.props.closeExpPopup():n.props.openExpPopup():n.props.closeExpPopup()},n.state={selectedExpFrom:n.getSelectedExpFromExpression(),isDropdownOpen:!1,inputValue:n.getStringFromExpression()},n}return at(t,e),t.prototype.componentDidUpdate=function(e,t){t.selectedExpFrom!==this.state.selectedExpFrom&&this.toggleExpPopup()},t.prototype.render=function(){var e,t,n,r,o,i=this,a=this.getWhetherFromExpBuilder(this.state.selectedExpFrom),p=a?this.props.expression&&this.props.expression.name||"":(null===(o=null===(r=null===(n=null===(t=this.props.expression)||void 0===t?void 0:t.parts)||void 0===n?void 0:n[0])||void 0===r?void 0:r.exp)||void 0===o?void 0:o.replace(/^"/,"").replace(/"$/,""))||"",c=s.expressionUtils.getWhetherExpressionValid(this.props.expression),l=this.getWhetherExpDssMatchInUseDss(this.props.expression),u=!c||!l,d=this.props,f=d.placeHolders,h=void 0===f?{}:f,x=d.autoHide,m=this.state.selectedExpFrom;return Object(s.jsx)("div",{style:this.props.style,className:Object(s.classNames)("w-100 h-100",(e={},e[this.props.className]=!!this.props.className,e))},Object(s.jsx)("div",{className:"d-flex justify-content-start align-items-center component-expression-input"},!(x&&(this.props.types||[]).length<=1)&&Object(s.jsx)("div",{className:"expression-builder-trigger"},Object(s.jsx)(g.Dropdown,{isOpen:this.state.isDropdownOpen,toggle:this.toggleDropdown,className:"w-100 h-100 expression-builder-trigger-dropdown"},Object(s.jsx)(g.DropdownButton,{arrow:!1,title:b(this.state.selectedExpFrom,this.props.intl),className:"text-truncate d-flex justify-content-center align-items-center trigger-dropdown-toggle p-0"},m&&Object(s.jsx)(g.Icon,{icon:this.getExpFromIcon(m),className:"m-0 p-0"})),Object(s.jsx)(g.DropdownMenu,null,this.props.types.map((function(e,t){return Object(s.jsx)(g.DropdownItem,{onClick:function(t){return i.onExpFromChange(e)},key:t,className:"text-dark"},Object(s.jsx)(g.Icon,{icon:i.getExpFromIcon(e),className:"mr-2"}),Object(s.jsx)("span",null,b(e,i.props.intl)))}))))),Object(s.jsx)("div",{className:"flex-grow-1 expression-input"},u&&a?p?Object(s.jsx)("div",{className:"w-100 h-100 text-truncate ds-disabled d-flex align-items-center",onClick:this.toggleExpPopup},Object(s.jsx)("span",{title:p},p)):Object(s.jsx)("div",{className:"w-100 h-100 text-truncate ds-disabled ds-placeholder d-flex align-items-center",onClick:this.toggleExpPopup},Object(s.jsx)("span",{title:h[m]},h[m])):Object(s.jsx)("div",{className:"w-100 h-100",onClick:a?this.toggleExpPopup:void 0},Object(s.jsx)("div",{className:"w-100 h-100"},Object(s.jsx)(g.TextInput,{className:Object(s.classNames)("w-100 h-100",{"ds-disabled":a}),value:p,disabled:a,onChange:this.onInputChange,onBlur:this.onInputBlur,title:p,placeholder:h[m]}),a&&Object(s.jsx)("div",{className:"ds-disabled disabled-input-cover"}))))),this.props.isExpPopupOpen?Object(s.jsx)(it,pt({},this.props,{onChange:this.onExpChange,types:this.getExpressionFrom(),isOpen:this.props.isExpPopupOpen,onClose:this.props.closeExpPopup})):null)},t}(s.React.PureComponent),ht=Object(s.injectIntl)(s.themeUtils.withStyles(ft,"ExpressionInput"));s.ThemeManager.getInstance().registerJimuThemeStyleModule("jimu-ui/advanced/expression-builder/",{componentStyles:r})}}))}}}));